name: Zyroo CI/CD

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

env:
  NODE_VERSION: '18'

jobs:
  # Backend Validation
  backend:
    name: ğŸš€ Backend - Test & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: âœ… Backend Syntax Check
        run: |
          cd backend
          npm run lint --if-present
          echo "âœ… Backend syntax validation passed"

      - name: ğŸ§ª Backend Health Check
        run: |
          cd backend
          # Start server in background
          npm start &
          # Wait for server to start
          sleep 10
          # Test health endpoint
          curl -f http://localhost:5000/api/health || exit 1
          echo "âœ… Backend server is healthy"

  # Frontend Validation
  frontend:
    name: âš¡ Frontend - Build & Test
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: http://localhost:5000/api

      - name: âœ… Frontend Syntax Check
        run: |
          cd frontend
          npm run lint --if-present
          echo "âœ… Frontend syntax validation passed"

  # Security Audit
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Backend Security Audit
        run: |
          cd backend
          npm audit --audit-level moderate || true

      - name: ğŸ” Frontend Security Audit
        run: |
          cd frontend
          npm audit --audit-level moderate || true

  # Deployment Ready Check
  deployment-check:
    name: ğŸŒ Deployment Ready
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âœ… All Checks Passed
        run: |
          echo "ğŸ‰ All CI/CD checks passed!"
          echo "âœ… Backend: Healthy and validated"
          echo "âœ… Frontend: Built successfully" 
          echo "âœ… Security: Audit completed"
          echo "ğŸš€ Ready for deployment to staging/production"
